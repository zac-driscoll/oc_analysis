---
title: "Oak Creek Site Selection"
author: "Zac Driscoll"
date: "8/27/2021"
output: 
  html_document:
    code_folding: hide
---
## {.tabset}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(mmsd.wq)
library(ggdendro)
library(DT)
library(sf)
library(wdnr.gis)
library(leaflet)

mds_params <-
  param_lookup_table %>%
  filter(op_sid %in%
           c(877, 196, 192, 189, 75, 213, 183, 181)) %>% #TOC, NH3, NO3, TP, TSS
  pull(op_sid)


oc_sites <-
  mmsd_wq_sites %>%
  filter(water_body == "Oak Creek") %>%
  pull(sitecode)

oc_data <- 
  get_survey_data(sitecode = oc_sites,
                  start_date = "2010-01-01",
                  end_date = "2020-12-31")

oc_data <- oc_data %>%
  mutate(reading_num = if_else(op_sid %in% c(880,213),
                               log10(reading_num), 
                               reading_num))


z_score_norm <- function(x) {
  (x - mean(x)) / sd(x)
  
}
  

min_max_norm <- function(x) {
  (x - min(x)) / (max(x) - min(x))
}


calc_t_test <- function(site1,site2,param){
  
  oc_data_t <- oc_data
  
  if (param %in% c(877, 196, 192, 189, 183, 179)) {
    oc_data_t <- oc_data_t %>%
      mutate(reading_num = log(reading_num))
  }
  if(param %in% c(880,213)){
    oc_data_t <- oc_data_t %>%
      mutate(reading_num = log10(reading_num))
  }
  
  oc_data_t <- 
    oc_data_t %>%
    filter(sitecode %in% c(as.character(site1),as.character(site2)) &
             op_sid == param) %>% 
    select(site_code,collection_date,reading_num) %>% 
    pivot_wider(names_from = "site_code", values_from = "reading_num")
 

  
  z <- t.test(pull(oc_data_t[,2])
         ,pull(oc_data_t[,3]),
         paired = TRUE,
         alternative = "two.sided")
  
  round(z$p.value,digits = 2)

}

make_table <- function(op_sid){
  results <- all_t_tests %>%
    filter(ops == op_sid) %>%
    select(-ops) %>%
    pivot_wider(names_from = site_2,values_from = p_value) %>%
      arrange(site_1) %>%
    rename(site = site_1)
  
  results[1,2:8] <- NA
  results[2,3:8] <- NA
  results[3,4:8] <- NA
  results[4,5:8] <- NA
  results[5,6:8] <- NA
  results[6,7:8] <- NA
  results[7,8:8] <- NA
  
  results

  }


all_t_tests <- expand.grid(oc_sites,oc_sites,c(mds_params,213,880,75))

all_t_tests <- all_t_tests %>%
  filter(Var1 != Var2)

all_t_tests <-
  all_t_tests %>%
  rename(site_1 = 1,
         site_2 = 2,
         ops = 3) %>%
  mutate(p_value =
           pmap_dbl(
             .l = list(..1 = site_1, ..2 = site_2, ..3 = ops),
             .f = 
               possibly(
               ~ calc_t_test(
               site1 = ..1,
               site2 = ..2,
               param = ..3
             ),
             otherwise = NA
           )
  )
  )

```

### Site Map

```{r, echo = FALSE,fig.height = 7, warning = FALSE, message = FALSE}


oak_creek <-get_hydro_layer(watershed_code = "040400020102")

oc_sites <- 
  mmsd.wq::mmsd_wq_sites %>%
  filter(water_body == "Oak Creek") %>%
  st_as_sf(coords = c("longitude","latitude"))
  
leaflet() %>%
  addPolylines(data = oak_creek, color = "black") %>%
  addPolylines(data = filter(oak_creek, RIVER_SYS_WBIC == 14500),
               color = "blue") %>%
  addProviderTiles(provider = providers$Esri.WorldImagery) %>%
  addCircleMarkers(data = oc_sites, color = "red", fillOpacity =  1,
                   label = ~ paste("Site Code:", sitecode))


```

### Boxplots
<h4> Site Comparison </h4><br>
Select a parameter and sites to see a boxplot of the data. <br>
```{r, echo = FALSE, warning = FALSE, message = FALSE}

oc_data_shared <- crosstalk::SharedData$new(oc_data)

crosstalk::bscols(
  crosstalk::filter_select(
    "oc_param",
    "Select a Parameter:",
    multiple = FALSE,
    sharedData = oc_data_shared,
    ~ parameter
  ),
        crosstalk::filter_select(
    "oc_site_compare",
    "Select Sites:",
    multiple = TRUE,
    sharedData = oc_data_shared,
    ~ site_code)
)
  
  plotly::plot_ly(
  data = oc_data_shared,
  y = ~ reading_num,
  x = ~ site_code,
  type = 'box'
)

```
<br>
<h4> Seasonal Trends  </h4><br>
Select a site and parameter to see seasonal trends in the data <br>
```{r,fig.width = 10, warning=FALSE}

oc_seasonal <- crosstalk::SharedData$new(oc_data)

crosstalk::bscols(
  crosstalk::filter_select(
    "oc_site",
    "Select a Site:",
    multiple = FALSE,
    sharedData = oc_seasonal,
    ~ sitecode
  ),
  crosstalk::filter_select(
    "oc_seasonal_param",
    "Select a Parameter:",
    multiple = FALSE,
    sharedData = oc_seasonal,
    ~ parameter
  )
)
plotly::plot_ly(
  data = oc_seasonal,
  y = ~ reading_num,
  x = ~ month,
  type = 'box'
)

```

### Timeseries
<h4> Time Series </h4><br>
Select sites, a parameter, and a year to compare time series. <br>
```{r,fig.width = 10, warning=FALSE}
oc_data2 <- oc_data %>% arrange(collection_date)
oc_seasonal2 <- crosstalk::SharedData$new(oc_data2)

crosstalk::bscols(
  crosstalk::filter_select(
    "oc_site2",
    "Select Sites:",
    multiple = TRUE,
    sharedData = oc_seasonal2,
    ~ sitecode
  ),
  crosstalk::filter_select(
    "oc_seasonal_param2",
    "Select a Parameter:",
    multiple = FALSE,
    sharedData = oc_seasonal2,
    ~ parameter
  ),
    crosstalk::filter_select(
    "oc_year",
    "Select a Year:",
    multiple = FALSE,
    sharedData = oc_seasonal2,
    ~ year
  )
)
plotly::plot_ly(
  data = oc_seasonal2,
  y = ~ reading_num,
  x = ~ month,
  type = 'scatter',
  mode = 'lines+markers',
  color = ~sitecode
)

```

### T-Tests 
<h4> Paired T-Tests </h4> <br>
Paired t-tests were performed between sites for several parameters. When
necessary, data were log transformed to meet the assumption of normality. Click
a parameter name to see the results.  The number within each of the cells are the 
p-values for the tests. Blue cells indicate that there is no significant difference
between the two stations for the given parameter (p-value > 0.05). 

<br>
<button class="btn btn-primary" data-toggle="collapse" data-target="#btn-ops-178"> pH </button> 
<div id="btn-ops-178" class="collapse"> 
```{r}

z <- make_table(178)

DT::datatable(make_table(178)) %>% 
  DT::formatStyle(
    colnames(z[2:8]),
    color = styleInterval(c(3.4, 3.8), c('white', 'blue', 'red')),
    backgroundColor = styleInterval(c(0.05), c('coral','dodgerblue'))
  )

```
</div>
<br>
<br>
<button class="btn btn-primary" data-toggle="collapse" data-target="#btn-ops-179"> Sp. Cond </button> 
<div id="btn-ops-179" class="collapse"> 
```{r}

z <- make_table(179)

DT::datatable(make_table(179)) %>% 
  DT::formatStyle(
    colnames(z[2:8]),
    color = styleInterval(c(3.4, 3.8), c('white', 'blue', 'red')),
    backgroundColor = styleInterval(c(0.05), c('coral','dodgerblue'))
  )

```
</div>
<br>
<br>
<button class="btn btn-primary" data-toggle="collapse" data-target="#btn-ops-181"> Temperature </button> 
<div id="btn-ops-181" class="collapse"> 
```{r}

z <- make_table(181)

DT::datatable(make_table(181)) %>% 
  DT::formatStyle(
    colnames(z[2:8]),
    color = styleInterval(c(3.4, 3.8), c('white', 'blue', 'red')),
    backgroundColor = styleInterval(c(0.05), c('coral','dodgerblue'))
  )

```
</div>
<br>
<br>
<button class="btn btn-primary" data-toggle="collapse" data-target="#btn-ops-182"> DO </button> 
<div id="btn-ops-182" class="collapse"> 
```{r}

z <- make_table(182)

DT::datatable(make_table(182)) %>% 
  DT::formatStyle(
    colnames(z[2:8]),
    color = styleInterval(c(3.4, 3.8), c('white', 'blue', 'red')),
    backgroundColor = styleInterval(c(0.05), c('coral','dodgerblue'))
  )

```
</div>
<br>
<br>
<button class="btn btn-primary" data-toggle="collapse" data-target="#btn-ops-183"> Turbidity </button> 
<div id="btn-ops-183" class="collapse"> 
```{r}

z <- make_table(183)

DT::datatable(make_table(183)) %>% 
  DT::formatStyle(
    colnames(z[2:8]),
    color = styleInterval(c(3.4, 3.8), c('white', 'blue', 'red')),
    backgroundColor = styleInterval(c(0.05), c('coral','dodgerblue'))
  )

```
</div>
<br>
<br>
<button class="btn btn-primary" data-toggle="collapse" data-target="#btn-ops-189"> NO5 </button> 
<div id="btn-ops-189" class="collapse"> 
```{r}

z <- make_table(189)

DT::datatable(make_table(189)) %>% 
  DT::formatStyle(
    colnames(z[2:8]),
    color = styleInterval(c(3.4, 3.8), c('white', 'blue', 'red')),
    backgroundColor = styleInterval(c(0.05), c('coral','dodgerblue'))
  )

```
</div>
<br>
<br>
<button class="btn btn-primary" data-toggle="collapse" data-target="#btn-ops-192"> NH3 </button> 
<div id="btn-ops-192" class="collapse"> 
```{r}

z <- make_table(192)

DT::datatable(make_table(192)) %>% 
  DT::formatStyle(
    colnames(z[2:8]),
    color = styleInterval(c(3.4, 3.8), c('white', 'blue', 'red')),
    backgroundColor = styleInterval(c(0.05), c('coral','dodgerblue'))
  )

```
</div>
<br>
<br>
<button class="btn btn-primary" data-toggle="collapse" data-target="#btn-ops-196"> TP </button> 
<div id="btn-ops-196" class="collapse"> 
```{r}

z <- make_table(196)

DT::datatable(make_table(196)) %>% 
  DT::formatStyle(
    colnames(z[2:8]),
    color = styleInterval(c(3.4, 3.8), c('white', 'blue', 'red')),
    backgroundColor = styleInterval(c(0.05), c('coral','dodgerblue'))
  )

```
</div>
<br>
<br>
<button class="btn btn-primary" data-toggle="collapse" data-target="#btn-ops-877"> TC </button> 
<div id="btn-ops-877" class="collapse"> 
```{r}

z <- make_table(877)

DT::datatable(make_table(877)) %>% 
  DT::formatStyle(
    colnames(z[2:8]),
    color = styleInterval(c(3.4, 3.8), c('white', 'blue', 'red')),
    backgroundColor = styleInterval(c(0.05), c('coral','dodgerblue'))
  )

```
</div>
<br>
<br>
<button class="btn btn-primary" data-toggle="collapse" data-target="#btn-ops-213"> Fecal </button> 
<div id="btn-ops-213" class="collapse"> 
```{r}

z <- make_table(213)

DT::datatable(make_table(213)) %>% 
  DT::formatStyle(
    colnames(z[2:8]),
    color = styleInterval(c(3.4, 3.8), c('white', 'blue', 'red')),
    backgroundColor = styleInterval(c(0.05), c('coral','dodgerblue'))
  )

```
</div>
<br>
<br>
<button class="btn btn-primary" data-toggle="collapse" data-target="#btn-ops-75"> TSS </button> 
<div id="btn-ops-75" class="collapse"> 
```{r}

z <- make_table(75)

DT::datatable(make_table(75)) %>% 
  DT::formatStyle(
    colnames(z[2:8]),
    color = styleInterval(c(3.4, 3.8), c('white', 'blue', 'red')),
    backgroundColor = styleInterval(c(0.05), c('coral','dodgerblue'))
  )

```
</div>
<br>
<br>

### Cluster Analysis

<h3> Description </h3>
Multidimensional scaling was performed to identify clusters within the data.
Parameters used within the analysis include: NH3, TC, TP, NH3, NO5, TS, Fecal,
Temp, and Turbidity.  Data were scaled by parameter groups using z scale 
normalization. When applicable, data were logged to normalize the data. The median
value was used for each site-parameter combo. <br>


```{r, echo = FALSE,warning = FALSE, message = FALSE}

oc_dist3 <- 
  oc_data %>%
  filter(op_sid %in% mds_params) %>%
  mutate(reading_num = case_when(
    op_sid %in% c(877,196,192,189,183,179) ~log(reading_num), 
    op_sid == 213 ~ log10(reading_num),
    TRUE ~ reading_num)) %>%
  group_by(parameter) %>% 
  mutate(reading_num = z_score_norm(reading_num)) %>%
  ungroup() %>%
  group_by(parameter, sitecode,month) %>%
  summarise(reading_num = median(reading_num)) %>%
  ungroup() %>%
  mutate(site_month = paste(sitecode,month,sep = "_")) %>%
  select(-month,-sitecode) %>%
  pivot_wider(names_from = "parameter",
              values_from = "reading_num") %>%
  select_if(~ !any(is.na(.))) %>%
  column_to_rownames("site_month") %>%
  dist()
  
  oc_mds3 <- 
  oc_dist3 %>%
  cmdscale() %>%
  as.data.frame() %>%
  rownames_to_column("site_month") %>%
  mutate(sitecode = sub("_.*","",site_month),
         month = sub(".*_","",site_month),
         season = case_when(month %in% c("Dec","Jan","Feb","Mar","Nov") ~ "Winter",
                             month %in% c("Apr","May") ~ "Spring",
                             month %in% c("Jun","Jul","Aug") ~ "Summer",
                             month %in% c("Sep","Oct") ~ "Fall"))



```
<br>
<h3> MDS Plot </h3>
Each point in the below plot represents a site-month (e.g. OC-01-MAY).  Points are colored 
by sitecode. No clear trend is observable. <br>
```{r, echo = FALSE, fig.width = 11, fig.height = 7}
p <- oc_mds3 %>%
  ggplot(aes(x = V1, y = V2, color = sitecode, 
             text = sitecode, label = month)) +
  geom_point(size = 4) +
  theme(legend.position = "right",
        legend.text=element_text(size=12),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
plotly::ggplotly(p)

```

<h3> MDS Plot </h3>
Each point in the below plot represents a site-month (e.g. OC-01-MAY).  Points are colored 
by season. A very strong seasonal trend is observable. <br>

```{r, echo = FALSE, fig.width = 11, fig.height = 7}

p <- oc_mds3 %>%
  ggplot(aes(x = V1, y = V2, color = season, 
             text = sitecode, label = month)) +
  geom_point(size = 4) +
  theme(legend.position = "right",
        legend.text=element_text(size=12),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

plotly::ggplotly(p)


```

